<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PACO - Central de Comando</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Login */
        #login-screen { text-align: center; margin-top: 100px; }
        input.login-input { padding: 15px; margin: 5px; border-radius: 5px; border: none; width: 250px; background: #333; color: white; }
        button { padding: 10px 20px; cursor: pointer; font-weight: bold; border: none; border-radius: 5px; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        .btn-green { background: #27ae60; color: white; }
        .btn-red { background: #c0392b; color: white; }
        .btn-blue { background: #2980b9; color: white; }
        .btn-gray { background: #7f8c8d; color: white; font-size: 11px; padding: 5px 10px;}

        /* Card da Oferta */
        .card { background: #1e1e1e; padding: 25px; margin-bottom: 25px; border-radius: 8px; border-left: 5px solid gray; box-shadow: 0 4px 10px rgba(0,0,0,0.3); position: relative; }
        .card.verde { border-left-color: #27ae60; }
        .card.vermelho { border-left-color: #c0392b; }
        .card.cinza { border-left-color: #f1c40f; }

        /* Campos Edit√°veis */
        label { display: block; font-size: 11px; color: #aaa; margin-bottom: 3px; margin-top: 10px; }
        input.edit-field { 
            background: #2d2d2d; border: 1px solid #444; color: white; padding: 8px; 
            border-radius: 4px; width: 95%; font-family: sans-serif;
        }
        input.edit-field:focus { border-color: #2980b9; outline: none; }
        
        .row { display: flex; gap: 15px; }
        .col { flex: 1; }

        .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px; }
        .status-badge { padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <div id="login-screen">
            <h2 style="color:#27ae60;">PACO V3</h2>
            <input type="email" id="email" class="login-input" placeholder="Email de Admin">
            <br>
            <input type="password" id="password" class="login-input" placeholder="Senha">
            <br><br>
            <button onclick="fazerLogin()" class="btn-green">ENTRAR</button>
            <p id="msg-login" style="color: #e74c3c; margin-top: 10px;"></p>
        </div>

        <div id="dashboard" class="hidden">
            <div class="header-row">
                <div>
                    <h1>Central de Comando</h1>
                    <button onclick="criarNovaOferta()" class="btn-green" style="margin-top:10px;">+ CRIAR NOVA OFERTA</button>
                </div>
                <button onclick="logout()" class="btn-red">Sair</button>
            </div>
            
            <div id="lista-ofertas">
                <p>Carregando m√°quina de vendas...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, addDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcVJ34TlzOVRUZ0SDJcl8OqF4V7PxxbIg",
            authDomain: "paco-core.firebaseapp.com",
            projectId: "paco-core",
            storageBucket: "paco-core.firebasestorage.app",
            messagingSenderId: "88467987691",
            appId: "1:88467987691:web:85892f360253aa957c72ae"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- AUTH ---
        window.fazerLogin = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                document.getElementById('msg-login').innerText = "Acesso Negado: " + error.message;
            }
        }
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                carregarPainel();
            }
        });

        // --- FUNCIONALIDADES NOVAS ---
        
        // 1. CRIAR OFERTA
        window.criarNovaOferta = async () => {
            const confirmacao = confirm("Criar uma nova oferta rascunho?");
            if(!confirmacao) return;

            try {
                // Cria documento na cole√ß√£o OFFERS
                const offerRef = await addDoc(collection(db, "offers"), {
                    headline: "Nova Oferta (Edite Aqui)",
                    name: "Subt√≠tulo da oferta",
                    price: "0,00",
                    createdAt: serverTimestamp()
                });

                // Cria documento na cole√ß√£o METRICS ligado √† oferta
                await addDoc(collection(db, "metrics"), {
                    offerId: offerRef.id,
                    sales: 0,
                    revenue: 0,
                    views: 0,
                    statusVisual: "cinza"
                });

                alert("Nova oferta criada! Role para baixo.");
                carregarPainel();

            } catch (e) {
                alert("Erro ao criar: " + e.message);
            }
        }

        // 2. EXCLUIR OFERTA
        window.excluirOferta = async (metricId, offerId) => {
            const certeza = confirm("TEM CERTEZA? Isso apaga a oferta e as m√©tricas para sempre.");
            if(!certeza) return;

            try {
                await deleteDoc(doc(db, "metrics", metricId));
                // Opcional: apagar a oferta tamb√©m, ou manter como hist√≥rico
                // await deleteDoc(doc(db, "offers", offerId)); 
                
                alert("Oferta removida do painel.");
                carregarPainel();
            } catch (e) {
                alert("Erro ao excluir: " + e.message);
            }
        }

        // --- CORE DO PAINEL ---
        async function carregarPainel() {
            const container = document.getElementById('lista-ofertas');
            container.innerHTML = ""; 

            // Busca M√©tricas
            const metricsSnap = await getDocs(collection(db, "metrics"));

            if (metricsSnap.empty) {
                container.innerHTML = "<p>Nenhuma oferta encontrada. Crie a primeira acima!</p>";
                return;
            }

            for (const metricDoc of metricsSnap.docs) {
                const mData = metricDoc.data();
                const offerId = mData.offerId;
                
                // Busca Dados da Oferta
                let offerData = { headline: "Carregando...", price: "..." };
                try {
                    const offerSnap = await getDoc(doc(db, "offers", offerId));
                    if (offerSnap.exists()) offerData = offerSnap.data();
                } catch(e) { console.error(e); }

                // HTML do Card
                const html = `
                    <div class="card ${mData.statusVisual}">
                        <div style="display:flex; justify-content:space-between; align-items: flex-start;">
                            <div>
                                <h3 style="margin:0; color:#27ae60;">OFERTA</h3>
                                <small style="color:#666; font-family:monospace;">ID: ${offerId}</small>
                            </div>
                            <div style="text-align:right;">
                                <span class="status-badge" style="background:${getStatusColor(mData.statusVisual)}">
                                    ${mData.statusVisual.toUpperCase()}
                                </span>
                                <br>
                                <button class="btn-gray" style="margin-top:5px; background:#444;" onclick="excluirOferta('${metricDoc.id}', '${offerId}')">üóëÔ∏è Excluir</button>
                            </div>
                        </div>

                        <div style="margin-top:20px; padding-bottom:15px; border-bottom:1px solid #333;">
                            <strong style="color:#aaa;">SITE (Cliente V√™)</strong>
                            <label>Headline</label>
                            <input type="text" class="edit-field" id="headline-${offerId}" value="${offerData.headline}">
                            
                            <div class="row">
                                <div class="col">
                                    <label>Pre√ßo</label>
                                    <input type="text" class="edit-field" id="price-${offerId}" value="${offerData.price}">
                                </div>
                                <div class="col">
                                    <label>Subt√≠tulo</label>
                                    <input type="text" class="edit-field" id="sub-${offerId}" value="${offerData.name || ''}">
                                </div>
                            </div>
                        </div>

                        <div style="margin-top:15px;">
                            <strong style="color:#aaa;">PAINEL (Voc√™ V√™)</strong>
                            <div class="row">
                                <div class="col">
                                    <label>Vendas</label>
                                    <input type="number" class="edit-field" id="sales-${metricDoc.id}" value="${mData.sales}">
                                </div>
                                <div class="col">
                                    <label>Receita (R$)</label>
                                    <input type="number" class="edit-field" id="revenue-${metricDoc.id}" value="${mData.revenue}">
                                </div>
                                <div class="col">
                                    <label>Status</label>
                                    <select id="status-${metricDoc.id}" class="edit-field">
                                        <option value="cinza" ${mData.statusVisual === 'cinza' ? 'selected' : ''}>üü° Testando</option>
                                        <option value="verde" ${mData.statusVisual === 'verde' ? 'selected' : ''}>üü¢ Validada</option>
                                        <option value="vermelho" ${mData.statusVisual === 'vermelho' ? 'selected' : ''}>üî¥ Reprovada</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top:20px; text-align:right;">
                            <a href="./?id=${offerId}" target="_blank" style="color:#aaa; text-decoration:none; margin-right:15px; font-size:12px;">Ver Link da P√°gina ‚Üó</a>
                            <button class="btn-blue" onclick="salvarTudo('${offerId}', '${metricDoc.id}')">üíæ SALVAR ALTERA√á√ïES</button>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            }
        }

        window.salvarTudo = async (offerId, metricId) => {
            try {
                const newHeadline = document.getElementById(`headline-${offerId}`).value;
                const newPrice = document.getElementById(`price-${offerId}`).value;
                const newSub = document.getElementById(`sub-${offerId}`).value;
                
                const newSales = Number(document.getElementById(`sales-${metricId}`).value);
                const newRevenue = Number(document.getElementById(`revenue-${metricId}`).value);
                const newStatus = document.getElementById(`status-${metricId}`).value;

                await updateDoc(doc(db, "offers", offerId), {
                    headline: newHeadline,
                    price: newPrice,
                    name: newSub
                });

                await updateDoc(doc(db, "metrics", metricId), {
                    sales: newSales,
                    revenue: newRevenue,
                    statusVisual: newStatus
                });

                alert("‚úÖ Salvo com sucesso!");
                carregarPainel();

            } catch (e) {
                alert("‚ùå Erro: " + e.message);
            }
        }

        function getStatusColor(status) {
            if(status === 'verde') return '#27ae60';
            if(status === 'vermelho') return '#c0392b';
            return '#f1c40f'; // cinza/amarelo
        }
    </script>
</body>
</html>
