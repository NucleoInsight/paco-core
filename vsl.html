<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Apresentação Especial</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #000; color: #fff; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; text-align: center; }
        
        h1 { font-size: 24px; color: #ff0000; margin-bottom: 20px; text-transform: uppercase; font-weight: 900; }
        .video-box { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #222; border: 2px solid #333; margin-bottom: 30px; border-radius: 8px;}
        .video-box iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        p { color: #ccc; font-size: 18px; line-height: 1.5; margin-bottom: 30px; }
        
        .cta-button { display: inline-block; background: #27ae60; color: #fff; padding: 20px 40px; font-size: 22px; font-weight: bold; text-decoration: none; border-radius: 5px; animation: pulse 2s infinite; border: none; cursor: pointer; width: 100%; max-width: 400px; }
        .cta-button:hover { background: #219150; }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(39, 174, 96, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); } }
        
        .hidden { display: none; }
        #loading { color: yellow; text-align: center; margin-top: 50px; font-weight: bold; }
        .footer { font-size: 11px; color: #444; margin-top: 50px; }
    </style>
</head>
<body>

    <div id="loading">CARREGANDO VSL...</div>

    <div id="app" class="container hidden">
        <h1 id="headline">...</h1>

        <div class="video-box">
            <iframe id="videoFrame" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>

        <p id="bodyText">...</p>

        <button id="buyBtn" class="cta-button">...</button>
        
        <div style="margin-top:20px; font-size:14px; color:#777; font-weight: bold;">Preço: R$ <span id="price">...</span></div>
        <div class="footer">Copyright © 2024. Todos os direitos reservados.</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURAÇÃO PACO-CORE
        const firebaseConfig = { apiKey: "AIzaSyBcVJ34TlzOVRUZ0SDJcl8OqF4V7PxxbIg", authDomain: "paco-core.firebaseapp.com", projectId: "paco-core", storageBucket: "paco-core.firebasestorage.app", messagingSenderId: "88467987691", appId: "1:88467987691:web:85892f360253aa957c72ae" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        // Lógica de Sessão e UTM (V38 Standard)
        const urlParams = new URLSearchParams(window.location.search);
        const offerId = urlParams.get('id');
        const isTest = urlParams.get('mode') === 'test';
        let sessionId = sessionStorage.getItem('paco_sid');
        if(!sessionId) { sessionId = 'u_' + Math.random().toString(36).substr(2, 9); sessionStorage.setItem('paco_sid', sessionId); }

        let source = urlParams.get('utm_source');
        if (!source) {
            const ref = document.referrer;
            if (ref.includes('instagram')) source = 'instagram';
            else if (ref.includes('facebook')) source = 'facebook';
            else if (ref.includes('youtube')) source = 'youtube';
            else if (ref) source = new URL(ref).hostname;
            else source = 'direto';
        }

        async function track(name, data={}) {
            if(!offerId) return;
            try { 
                await addDoc(collection(db, "events"), { 
                    offerId, sessionId, type: name, isTest, 
                    campaign: {source, campaign: urlParams.get('utm_campaign')||''}, 
                    createdAt: serverTimestamp(), data 
                }); 
            } catch(e){}
        }

        async function init() {
            if (!offerId) { document.getElementById('loading').innerText = "ERRO: Link sem ID de oferta."; return; }

            try {
                const docSnap = await getDoc(doc(db, "offers", offerId));
                if (docSnap.exists()) {
                    const data = docSnap.data();

                    document.getElementById('headline').innerText = data.headline;
                    document.getElementById('bodyText').innerText = data.bodyText;
                    document.getElementById('buyBtn').innerText = data.ctaText || "QUERO TER ACESSO AGORA";
                    document.getElementById('price').innerText = data.price;
                    
                    // CORREÇÃO DE VÍDEO (Mesma lógica do Index)
                    if(data.videoUrl && data.videoUrl.length > 5) {
                        let vUrl = data.videoUrl.replace("watch?v=", "embed/").replace("youtu.be/", "www.youtube.com/embed/");
                        vUrl += (vUrl.includes('?') ? '&' : '?') + "rel=0&playsinline=1&modestbranding=1";
                        document.getElementById('videoFrame').src = vUrl;
                    }

                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');

                    // Rastreia visualização no Dashboard
                    track('offer_view');

                    // Configura o botão
                    document.getElementById('buyBtn').onclick = () => {
                        track('cta_click');
                        const btn = document.getElementById('buyBtn');
                        btn.innerText = "REDIRECIONANDO...";
                        btn.style.opacity = "0.7";
                        
                        if(data.checkoutUrl) window.location.href = data.checkoutUrl;
                        else alert("Checkout não configurado.");
                    };
                } else {
                    document.getElementById('loading').innerText = "Oferta não encontrada.";
                }
            } catch (e) { console.error(e); }
        }
        init();
    </script>
</body>
</html>
