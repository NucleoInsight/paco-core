<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Oferta Especial</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; transition: 0.3s; }
        .hidden { display: none !important; }
        #loading { position: fixed; inset: 0; background: #000; color: #0f0; display: flex; justify-content: center; align-items: center; z-index: 9999; font-weight: bold; }
        
        /* TEMAS */
        body.layout-dark { background-color: #0b0c15; color: white; }
        .layout-dark .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        body.layout-clean { background-color: #f8fafc; color: #1e293b; }
        .layout-clean .container { max-width: 600px; margin: 40px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        body.layout-quiz { background-color: #0b0c15; color: white; }
        .layout-quiz .container { max-width: 500px; margin: 40px auto; padding: 20px; text-align: center; }

        /* VIDEO ZOOM HACK + ESCUDO */
        .video-box { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: #000; margin: 20px 0; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }
        .video-box iframe { position: absolute; top: -17%; left: -17%; width: 134%; height: 134%; z-index: 1; }
        
        /* ESCUDO INVISÍVEL: Bloqueia o clique (Pause) */
        .video-shield { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; background: transparent; }

        .btn { background: #10b981; color: #064e3b; width: 100%; padding: 18px; border-radius: 8px; font-weight: 800; text-transform: uppercase; border: none; cursor: pointer; margin-top: 20px; }
        .quiz-option { background: #1e293b; border: 1px solid #334155; padding: 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; text-align: left; }
        .quiz-option:hover { border-color: #10b981; }
    </style>
</head>
<body class="layout-dark">

    <div id="loading">CARREGANDO...</div>
    <div id="test-banner" style="background:#f59e0b;color:#000;text-align:center;font-size:10px;padding:5px;display:none">MODO TESTE</div>

    <div id="quiz-area" class="container hidden">
        <div style="background:#334155;height:4px;width:100%;margin-bottom:20px"><div id="progress-bar" style="background:#10b981;height:100%;width:0%"></div></div>
        <h2 id="quiz-question" style="font-size:20px;font-weight:800;margin-bottom:20px">...</h2>
        <div id="quiz-options"></div>
    </div>

    <div id="app" class="container hidden">
        <h1 id="headline" style="font-size:24px;font-weight:800;margin-bottom:20px">...</h1>
        
        <div id="videoArea" class="video-box" style="display:none">
            <iframe id="videoFrame" src="" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>
            <div class="video-shield" onclick="alert('O vídeo já começou! Assista até o final.')"></div>
        </div>

        <div id="bodyText" style="opacity:0.8;line-height:1.6">...</div>
        <p id="priceDisplay" style="font-size:24px;font-weight:bold;margin-top:20px;text-align:center">...</p>
        <button id="buyBtn" class="btn">...</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CHAVE PACO-CORE
        const firebaseConfig = { apiKey: "AIzaSyBcVJ34TlzOVRUZ0SDJcl8OqF4V7PxxbIg", authDomain: "paco-core.firebaseapp.com", projectId: "paco-core", storageBucket: "paco-core.firebasestorage.app", messagingSenderId: "88467987691", appId: "1:88467987691:web:85892f360253aa957c72ae" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const offerId = urlParams.get('id');
        const isTest = urlParams.get('mode') === 'test';
        let sessionId = sessionStorage.getItem('paco_sid');
        if(!sessionId) { sessionId = 'u_' + Math.random().toString(36).substr(2, 9); sessionStorage.setItem('paco_sid', sessionId); }

        let source = urlParams.get('utm_source');
        if (!source) {
            const ref = document.referrer;
            if (ref.includes('instagram')) source = 'instagram';
            else if (ref.includes('facebook')) source = 'facebook';
            else if (ref.includes('youtube')) source = 'youtube';
            else if (ref) source = new URL(ref).hostname;
            else source = 'direto';
        }

        async function track(name, data={}) {
            if(!offerId) return;
            try { await addDoc(collection(db, "events"), { offerId, sessionId, type: name, isTest, campaign: {source, campaign: urlParams.get('utm_campaign')||''}, createdAt: serverTimestamp(), data }); } catch(e){}
        }

        const questions = [ { t: "Objetivo?", a: ["Dinheiro", "Tempo", "Conhecimento"] }, { t: "Obstáculo?", a: ["Grana", "Foco", "Medo"] }, { t: "Investimento?", a: ["Pouco", "Médio", "Alto"] }, { t: "Bora?", a: ["Sim", "Talvez"] } ];

        async function init() {
            if (!offerId) { document.body.innerHTML = "Link inválido"; return; }
            if(isTest) document.getElementById('test-banner').style.display='block';
            try {
                const docSnap = await getDoc(doc(db, "offers", offerId));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    let layout = data.layout || 'dark';
                    if(layout === 'vsl') layout = 'dark';
                    document.body.className = `layout-${layout}`;

                    if(layout === 'quiz') { document.getElementById('loading').classList.add('hidden'); startQuiz(data); return; }
                    
                    renderOffer(data);
                }
            } catch (e) { console.error(e); }
        }

        function renderOffer(data) {
            document.getElementById('headline').innerText = data.headline;
            document.getElementById('bodyText').innerText = data.bodyText;
            document.getElementById('priceDisplay').innerText = "R$ " + data.price;
            document.getElementById('buyBtn').innerText = data.ctaText || "COMPRAR";

            // --- HACK FINAL (Anti-Recomendação + Anti-Pause) ---
            if(data.videoUrl && data.videoUrl.length > 5) {
                let videoId = "";
                const match = data.videoUrl.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|.*\/)([^#&?]*))/);
                if (match && match[1]) videoId = match[1];

                if(videoId) {
                    // Adicionei disablekb=1 para bloquear teclado e mantive loop
                    let vUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=0&rel=0&playsinline=1&modestbranding=1&iv_load_policy=3&showinfo=0&fs=0&disablekb=1&loop=1&playlist=${videoId}`;
                    document.getElementById('videoFrame').src = vUrl;
                    document.getElementById('videoArea').style.display = "block";
                }
            }

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            track('offer_view');
            
            document.getElementById('buyBtn').onclick = () => {
                track('cta_click');
                const btn = document.getElementById('buyBtn');
                btn.innerText = "AGUARDE...";
                if(data.checkoutUrl) window.location.href = data.checkoutUrl;
                else alert("Link não configurado");
            };
        }

        function startQuiz(offerData) {
            document.getElementById('quiz-area').classList.remove('hidden');
            track('offer_view');
            let qIdx = 0;
            function showQ() {
                const q = questions[qIdx];
                document.getElementById('quiz-question').innerText = q.t;
                const opts = document.getElementById('quiz-options');
                opts.innerHTML = "";
                document.getElementById('progress-bar').style.width = ((qIdx/questions.length)*100)+"%";
                q.a.forEach(ans => {
                    const d = document.createElement('div');
                    d.className = 'quiz-option'; d.innerText = ans;
                    d.onclick = () => { track('quiz_answer', {answer: ans}); qIdx++; if(qIdx<questions.length) showQ(); else finishQuiz(offerData); };
                    opts.appendChild(d);
                });
            }
            showQ();
        }

        function finishQuiz(offerData) {
            document.getElementById('quiz-area').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('loading').innerText = "ANALISANDO...";
            setTimeout(() => { document.body.className = 'layout-dark'; renderOffer(offerData); }, 1500);
        }

        init();
    </script>
</body>
</html>
